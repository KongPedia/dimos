name: cleanup-runner

on:
  workflow_run:
    workflows: ["docker"]
    types: [completed]
  workflow_dispatch: 

jobs:
  cleanup:
    runs-on: [self-hosted, Linux]
    steps:
      - name: Check disk usage
        id: disk-check
        run: |
          USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
          echo "Disk usage: ${USAGE}%"
          echo "usage=${USAGE}" >> $GITHUB_OUTPUT
          
      - name: Clean Docker images
        if: steps.disk-check.outputs.usage > 50
        run: |
          echo "=== Docker usage before cleanup ==="
          docker system df
          
          echo -e "\n=== Removing dangling images ==="
          docker images -f "dangling=true" -q | xargs -r docker rmi || true
          
          echo -e "\n=== Docker usage after cleanup ==="
          docker system df
          
          echo -e "\n=== Disk usage after cleanup ==="
          df -h /
          
      - name: Aggressive cleanup if disk critically full
        if: steps.disk-check.outputs.usage > 90
        run: |
          echo "=== CRITICAL: Disk usage above 90% - Aggressive cleanup ==="
          
          echo -e "\n=== Removing images older than 3 days ==="
          docker image prune -a --filter "until=72h" -f
          
          echo -e "\n=== Final docker usage ==="
          docker system df
          
          echo -e "\n=== Final disk usage ==="
          df -h /