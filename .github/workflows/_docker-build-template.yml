name: docker-build-template
on:
  workflow_call:
    inputs:
      from-image:  { type: string, required: true }
      to-image:    { type: string, required: true }
      dockerfile:  { type: string, required: true }
      freespace:   { type: boolean, default: false }
      should-run:  { type: boolean, default: false }
      context:     { type: string, default: '.' }

# you can run this locally as well via
# ./bin/dockerbuild [image-name]
jobs:
  build:
    runs-on: dimos-runner-ubuntu-2204
    permissions:
      contents: read
      packages: write

    steps:
      - name: exit early
        if: ${{ !inputs.should-run }}
        run: |
          exit 0
      - name: free up disk space
        # takes a bit of time, so disabled by default
        # explicitly enable this for large builds
        if: ${{ inputs.freespace }}
        run: |
          echo -e "pre cleanup space:\n $(df -h)"
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          echo -e "post cleanup space:\n $(df -h)"

      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # required for github cache of docker layers
      - uses: crazy-max/ghaction-github-runtime@v3

      # required for github cache of docker layers
      - uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          install: true
          use: true

      - uses: docker/build-push-action@v6
        with:
          push: true
          context: ${{ inputs.context }}
          file:   docker/${{ inputs.dockerfile }}/Dockerfile
          tags:   ${{ inputs.to-image }}
          cache-from: type=gha,scope=${{ inputs.dockerfile }}
          cache-to:   type=gha,mode=max,scope=${{ inputs.dockerfile }}
          #cache-from: type=gha,scope=${{ inputs.dockerfile }}-${{ inputs.from-image }}
          #cache-to:   type=gha,mode=max,scope=${{ inputs.dockerfile }}-${{ inputs.from-image }}
          build-args: FROM_IMAGE=${{ inputs.from-image }}
