name: docker
on:
  push:
    branches:
      - main
      - dev
  pull_request:

permissions:
  contents: read
  packages: write
  pull-requests: read

jobs:
  check-changes:
    runs-on: [self-hosted, Linux]
    outputs:
      ros:    ${{ steps.filter.outputs.ros }}
      python: ${{ steps.filter.outputs.python }}
      dev:    ${{ steps.filter.outputs.dev }}
      tests:  ${{ steps.filter.outputs.tests }}
      branch-tag: ${{ steps.set-tag.outputs.branch_tag }}
    steps:
      - name: Fix permissions
        run: |
          sudo chown -R $USER:$USER ${{ github.workspace }} || true
          
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.before }}
          filters: |
            # ros and python are (alternative) root images
            # change to root stuff like docker.yml etc triggers rebuild of those
            # which cascades into a full rebuild
            ros:
              - .github/workflows/_docker-build-template.yml
              - .github/workflows/docker.yml
              - docker/ros/**

            python:
              - .github/workflows/_docker-build-template.yml
              - .github/workflows/docker.yml
              - docker/python/**
              - pyproject.toml

            dev:
              - docker/dev/**

            tests:
              - dimos/**

      - name: Determine Branch Tag
        id: set-tag
        run: |
          case "${GITHUB_REF_NAME}" in
            main) branch_tag="latest" ;;
            dev)    branch_tag="dev"    ;;
            *)
              branch_tag=$(echo "${GITHUB_REF_NAME}" \
                  | tr '[:upper:]' '[:lower:]' \
                  | sed -E 's#[^a-z0-9_.-]+#_#g' \
                  | sed -E 's#^-+|-+$##g')
              ;;
          esac
          echo "branch tag determined: ${branch_tag}"
          echo branch_tag="${branch_tag}" >> "$GITHUB_OUTPUT"

  pre-build-cleanup:
    needs: [check-changes]
    runs-on: [self-hosted, Linux]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Clean deleted branches
        run: |
          echo "=== Cleaning images from deleted branches ==="
          
          # Get list of all remote branches
          git ls-remote --heads origin | awk '{print $2}' | sed 's|refs/heads/||' > /tmp/active_branches.txt
          
          # Check each docker image tag against branch list
          docker images --format "{{.Repository}}:{{.Tag}}|{{.ID}}" | \
          grep "ghcr.io/dimensionalos" | \
          grep -v ":<none>" | \
          while IFS='|' read image_ref id; do
            tag=$(echo "$image_ref" | cut -d: -f2)
            
            # Skip if tag matches an active branch
            if grep -qx "$tag" /tmp/active_branches.txt; then
              echo "Branch exists: $tag - keeping $image_ref"
            else
              echo "Branch deleted: $tag - removing $image_ref"
              docker rmi "$id" 2>/dev/null || true
            fi
          done
          
          rm -f /tmp/active_branches.txt
          
      - name: Quick cleanup if needed
        run: |
          USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
          echo "Pre-build disk usage: ${USAGE}%"
          
          if [ $USAGE -gt 80 ]; then
            echo "=== Running quick cleanup (usage > 80%) ==="
            
            # Keep newest image per tag
            docker images --format "{{.Repository}}|{{.Tag}}|{{.ID}}" | \
            grep "ghcr.io/dimensionalos" | \
            grep -v "<none>" | \
            while IFS='|' read repo tag id; do
              created_ts=$(docker inspect -f '{{.Created}}' "$id" 2>/dev/null)
              created_unix=$(date -d "$created_ts" +%s 2>/dev/null || echo "0")
              echo "${repo}|${tag}|${id}|${created_unix}"
            done | sort -t'|' -k1,1 -k2,2 -k4,4nr | \
            awk -F'|' '
            {
              repo=$1; tag=$2; id=$3
              repo_tag = repo ":" tag
              
              # Skip protected tags
              if (tag ~ /^(main|dev|latest)$/) next
              
              # Keep newest per tag, remove older duplicates
              if (!(repo_tag in seen_combos)) {
                seen_combos[repo_tag] = 1
              } else {
                system("docker rmi " id " 2>/dev/null || true")
              }
            }'
            
            docker image prune -f
            docker volume prune -f
            
            echo "Post-cleanup usage: $(df / | awk 'NR==2 {print $5}')"
          fi

  # just a debugger
  inspect-needs:
    needs: [check-changes, ros]
    runs-on: dimos-runner-ubuntu-2204
    if: always()
    steps:
      - run: |
          echo '${{ toJSON(needs) }}'

  ros:
    needs: [check-changes, pre-build-cleanup]
    if: needs.check-changes.outputs.ros == 'true'
    uses: ./.github/workflows/_docker-build-template.yml
    with:
      should-run: true
      from-image: ubuntu:22.04
      to-image: ghcr.io/dimensionalos/ros:${{ needs.check-changes.outputs.branch-tag }}
      dockerfile:  ros

  ros-python:
    needs: [check-changes, ros, pre-build-cleanup]
    if: always()
    uses: ./.github/workflows/_docker-build-template.yml
    with:
      should-run: ${{
        needs.check-changes.outputs.python == 'true' &&
        needs.check-changes.result != 'error' &&
        needs.ros.result != 'error'
        }}

      from-image: ghcr.io/dimensionalos/ros:${{ needs.ros.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}
      to-image: ghcr.io/dimensionalos/ros-python:${{ needs.check-changes.outputs.branch-tag }}
      dockerfile:  python
      freespace: true

  python:
    needs: [check-changes, pre-build-cleanup]
    if: needs.check-changes.outputs.python == 'true'
    uses: ./.github/workflows/_docker-build-template.yml
    with:
      should-run: true
      freespace: true
      dockerfile:  python
      from-image: ubuntu:22.04
      to-image: ghcr.io/dimensionalos/python:${{ needs.check-changes.outputs.branch-tag }}

  dev:
    needs: [check-changes, python, pre-build-cleanup]
    if: always()

    uses: ./.github/workflows/_docker-build-template.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' &&
        ((needs.python.result == 'success') ||
        (needs.python.result == 'skipped' &&
        needs.check-changes.outputs.dev == 'true')) }}
      from-image: ghcr.io/dimensionalos/python:${{ needs.python.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}
      to-image: ghcr.io/dimensionalos/dev:${{ needs.check-changes.outputs.branch-tag }}
      dockerfile: dev

  ros-dev:
    needs: [check-changes, ros-python, pre-build-cleanup]
    if: always()
    uses: ./.github/workflows/_docker-build-template.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' && ((needs.ros-python.result == 'success') || (needs.ros-python.result == 'skipped')) && (needs.check-changes.outputs.dev == 'true')
        }}
      from-image: ghcr.io/dimensionalos/ros-python:${{ needs.ros-python.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}
      to-image: ghcr.io/dimensionalos/ros-dev:${{ needs.check-changes.outputs.branch-tag }}
      dockerfile: dev

  run-ros-tests:
    needs: [check-changes, ros-dev]
    if: always()
    uses: ./.github/workflows/tests.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' &&
        ((needs.ros-dev.result == 'success') ||
        (needs.ros-dev.result == 'skipped' &&
        needs.check-changes.outputs.tests == 'true'))
        }}
      cmd: "pytest && pytest -m ros" # run tests that depend on ros as well
      dev-image: ros-dev:${{ needs.check-changes.outputs.dev == 'true' && needs.ros-dev.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}

  run-tests:
    needs: [check-changes, dev]
    if: always()
    uses: ./.github/workflows/tests.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' &&
        ((needs.dev.result == 'success') ||
        (needs.dev.result == 'skipped' &&
        needs.check-changes.outputs.tests == 'true'))
        }}
      cmd: "pytest"
      dev-image: dev:${{ needs.check-changes.outputs.dev == 'true' && needs.dev.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}

  # we run in parallel with normal tests for speed
  run-heavy-tests:
    needs: [check-changes, dev]
    if: always()
    uses: ./.github/workflows/tests.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' &&
        ((needs.dev.result == 'success') ||
        (needs.dev.result == 'skipped' &&
        needs.check-changes.outputs.tests == 'true'))
        }}
      cmd: "pytest -m heavy"
      dev-image: dev:${{ needs.check-changes.outputs.dev == 'true' && needs.dev.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}

  run-lcm-tests:
    needs: [check-changes, dev]
    if: always()
    uses: ./.github/workflows/tests.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' &&
        ((needs.dev.result == 'success') ||
        (needs.dev.result == 'skipped' &&
        needs.check-changes.outputs.tests == 'true'))
        }}
      cmd: "pytest -m lcm"
      dev-image: dev:${{ needs.check-changes.outputs.dev == 'true' && needs.dev.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}

  # Run module tests directly to avoid pytest forking issues
  # run-module-tests:
  #   needs: [check-changes, dev]
  #   if: ${{
  #     always() &&
  #     needs.check-changes.result == 'success' &&
  #     ((needs.dev.result == 'success') ||
  #     (needs.dev.result == 'skipped' &&
  #     needs.check-changes.outputs.tests == 'true'))
  #     }}
  #   runs-on: [self-hosted, x64, 16gb]
  #   container:
  #     image: ghcr.io/dimensionalos/dev:${{ needs.check-changes.outputs.dev == 'true' && needs.dev.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}
  #   steps:
  #     - name: Fix permissions
  #       run: |
  #         sudo chown -R $USER:$USER ${{ github.workspace }} || true
  #         
  #     - uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #         
  #     - name: Configure Git LFS
  #       run: |
  #         git config --global --add safe.directory '*'
  #         git lfs install
  #         git lfs fetch
  #         git lfs checkout
  #       
  #     - name: Run module tests
  #       env:
  #         CI: "true"
  #       run: |
  #         /entrypoint.sh bash -c "pytest -m module"
      
  # TODO: Remove when merge to main as workflow_run needed
  cleanup-runner:
    needs: [run-tests, run-heavy-tests, run-ros-tests, run-lcm-tests] 
    runs-on: [self-hosted, Linux]
    steps:
      - name: Check disk usage
        id: disk-check
        run: |
          USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
          echo "Disk usage: ${USAGE}%"
          echo "usage=${USAGE}" >> $GITHUB_OUTPUT
          
      - name: Clean Docker images
        if: steps.disk-check.outputs.usage > 50
        run: |
          echo "=== Docker usage before cleanup ==="
          docker system df
          
          echo -e "\n=== Removing dangling images ==="
          docker images -f "dangling=true" -q | xargs -r docker rmi || true
          
          echo -e "\n=== Docker usage after cleanup ==="
          docker system df
          
          echo -e "\n=== Disk usage after cleanup ==="
          df -h /
          
      - name: Aggressive cleanup if disk critically full
        if: steps.disk-check.outputs.usage > 90
        run: |
          echo "=== CRITICAL: Disk usage above 90% - Aggressive cleanup ==="
          
          echo -e "\n=== Removing images older than 3 days ==="
          docker image prune -a --filter "until=72h" -f
          
          echo -e "\n=== Final docker usage ==="
          docker system df
          
          echo -e "\n=== Final disk usage ==="
          df -h /
