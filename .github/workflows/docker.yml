name: docker
on: workflow_call

permissions:
  contents: read
  packages: write
  pull-requests: read


jobs:
  check-changes:
    runs-on: dimos-runner-ubuntu-2204
    outputs:
      ros:    ${{ steps.filter.outputs.ros }}
      python: ${{ steps.filter.outputs.python }}
      dev:    ${{ steps.filter.outputs.dev }}
      tests:  ${{ steps.filter.outputs.tests }}
      branch-tag: ${{ steps.set-tag.outputs.branch_tag }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.before }}
          filters: |
            ros:
              # ros rebuild will cascade to full rebuild
              # this is why check-changes to this workflow trigger ros
              - .github/workflows/_docker-build-template.yml
              - .github/workflows/docker.yml
              - docker/ros/**

            python:
              - docker/python/**
              - requirements*.txt

            dev:
              - docker/dev/**

            tests:
              - dimos/**

      - name: Determine Branch Tag
        id: set-tag
        run: |
          case "${GITHUB_REF_NAME}" in
            main) branch_tag="latest" ;;
            dev)    branch_tag="dev"    ;;
            *)
              branch_tag=$(echo "${GITHUB_REF_NAME}" \
                  | tr '[:upper:]' '[:lower:]' \
                  | sed -E 's#[^a-z0-9_.-]+#_#g' \
                  | sed -E 's#^-+|-+$##g')
              ;;
          esac
          echo "branch tag determined: ${branch_tag}"
          echo branch_tag="${branch_tag}" >> "$GITHUB_OUTPUT"

  # just a debugger
  inspect-needs:
    needs: [check-changes, ros]
    runs-on: dimos-runner-ubuntu-2204
    if: always()
    steps:
      - run: |
          echo '${{ toJSON(needs) }}'

  ros:
    needs: [check-changes]
    if: needs.check-changes.outputs.ros == 'true'
    uses: ./.github/workflows/_docker-build-template.yml
    with:
      from-image: ubuntu:22.04
      to-image: ghcr.io/dimensionalos/ros:${{ needs.check-changes.outputs.branch-tag }}
      dockerfile:  ros

  # # just a debugger
  # inspect-needs:
  #   needs: [check-changes, ros]
  #   runs-on: dimos-runner-ubuntu-2204
  #   if: always()
  #   steps:
  #     - run: |
  #         echo '${{ toJSON(needs) }}'

  ros-python:
    needs: [check-changes, ros]
    if: always()
    uses: ./.github/workflows/_docker-build-template.yml
    with:
      should-run: ${{
        needs.check-changes.outputs.python == 'true' &&
        needs.check-changes.result != 'error' &&
        needs.ros.result != 'error'
        }}

      from-image: ghcr.io/dimensionalos/ros:${{ needs.ros.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}
      to-image: ghcr.io/dimensionalos/ros-python:${{ needs.check-changes.outputs.branch-tag }}
      dockerfile:  python
      freespace: true

  python:
    needs: [check-changes]
    if: needs.check-changes.outputs.python == 'true'
    uses: ./.github/workflows/_docker-build-template.yml
    with:
      should-run: true
      freespace: true
      dockerfile:  python
      from-image: ubuntu:22.04
      to-image: ghcr.io/dimensionalos/python:${{ needs.check-changes.outputs.branch-tag }}

  dev:
    needs: [check-changes, python]
    if: always()

    uses: ./.github/workflows/_docker-build-template.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' &&
        ((needs.python.result == 'success') ||
        (needs.python.result == 'skipped' &&
        needs.check-changes.outputs.dev == 'true')) }}
      from-image: ghcr.io/dimensionalos/python:${{ needs.python.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}
      to-image: ghcr.io/dimensionalos/dev:${{ needs.check-changes.outputs.branch-tag }}
      dockerfile: dev

  ros-dev:
    needs: [check-changes, ros-python]
    if: always()
    uses: ./.github/workflows/_docker-build-template.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' &&
        ((needs.ros-python.result == 'success') ||
        (needs.ros-python.result == 'skipped' &&
        needs.check-changes.outputs.dev == 'true'))
        }}
      from-image: ghcr.io/dimensionalos/ros-python:${{ needs.ros-python.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}
      to-image: ghcr.io/dimensionalos/ros-dev:${{ needs.check-changes.outputs.branch-tag }}
      dockerfile: dev

  run-ros-tests:
    needs: [check-changes, ros-dev]
    if: always()
    uses: ./.github/workflows/tests.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' &&
        ((needs.ros-dev.result == 'success') ||
        (needs.ros-dev.result == 'skipped' &&
        needs.check-changes.outputs.tests == 'true'))
        }}
      cmd: "pytest && pytest -m ros" # run tests that depend on ros as well
      dev-image: ros-dev:${{ needs.ros-dev.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}

  run-tests:
    needs: [check-changes, dev]
    if: always()
    uses: ./.github/workflows/tests.yml
    with:
      should-run: ${{
        needs.check-changes.result == 'success' &&
        ((needs.dev.result == 'success') ||
        (needs.dev.result == 'skipped' &&
        needs.check-changes.outputs.tests == 'true'))
        }}
      cmd: "pytest"
      dev-image: dev:${{ needs.dev.result == 'success' && needs.check-changes.outputs.branch-tag || 'dev' }}
