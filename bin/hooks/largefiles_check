#!/usr/bin/env python3
"""Pre-commit hook to detect large files that should be in LFS."""

import argparse
import fnmatch
import os
import shutil
import subprocess
import sys

import tomli

parser = argparse.ArgumentParser()
parser.add_argument("--all", action="store_true", help="Check all files in repo, not just staged")
args = parser.parse_args()

# Check git-lfs is installed
if not shutil.which("git-lfs"):
    print("git-lfs is not installed.")
    print("\nInstall with:")
    print("  Arch:   pacman -S git-lfs")
    print("  Ubuntu: apt install git-lfs")
    print("  macOS:  brew install git-lfs")
    print("\nThen run: git lfs install")
    sys.exit(1)

# Load config
with open("pyproject.toml", "rb") as f:
    config = tomli.load(f).get("tool", {}).get("largefiles", {})

max_size_kb = config.get("max_size_kb", 50)
max_bytes = max_size_kb * 1024
ignore_patterns = config.get("ignore", [])

# Get LFS files to exclude
result = subprocess.run(
    ["git", "lfs", "ls-files", "-n"], capture_output=True, text=True, check=True
)
lfs_files = set(result.stdout.splitlines())

# Get files to check
if args.all:
    files_cmd = ["git", "ls-files"]
else:
    files_cmd = ["git", "diff", "--cached", "--name-only"]

violations = []
result = subprocess.run(files_cmd, capture_output=True, text=True, check=True)
for file in result.stdout.splitlines():
    if file in lfs_files:
        continue
    if any(fnmatch.fnmatch(file, p) for p in ignore_patterns):
        continue
    if os.path.isfile(file) and os.path.getsize(file) > max_bytes:
        violations.append((file, os.path.getsize(file)))

if violations:
    print(f"Large files detected (limit: {max_size_kb}KB):")
    for f, size in sorted(violations, key=lambda x: -x[1]):
        print(f"  {size // 1024}KB  {f}")
    print("\nEither add to LFS or to [tool.largefiles].ignore in pyproject.toml")
    sys.exit(1)
