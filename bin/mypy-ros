#!/bin/bash

set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

mypy_args=(--show-error-codes --hide-error-context --no-pretty)

main() {
  cd "$ROOT"

  if [ -z "$(docker images -q dimos-ros-dev)" ]; then
    (cd docker/ros; docker build -t dimos-ros .)
    docker build -t dimos-ros-python --build-arg FROM_IMAGE=dimos-ros -f docker/python/Dockerfile .
    docker build -t dimos-ros-dev --build-arg FROM_IMAGE=dimos-ros-python -f docker/dev/Dockerfile .
  fi

  sudo rm -fr .mypy_cache_docker
  rm -fr .mypy_cache_local

  {
    mypy_docker &
    mypy_local &
    wait
  } | sort -u
}

cleaned() {
  grep ': error: ' | sort
}

mypy_docker() {
  docker run --rm -v $(pwd):/app -w /app dimos-ros-dev bash -c "
    source /opt/ros/humble/setup.bash &&
    MYPYPATH=/opt/ros/humble/lib/python3.10/site-packages mypy ${mypy_args[*]} --cache-dir .mypy_cache_docker dimos
  " | cleaned
}

mypy_local() {
  MYPYPATH=/opt/ros/jazzy/lib/python3.12/site-packages \
  mypy "${mypy_args[@]}" --cache-dir .mypy_cache_local dimos | cleaned
}

main "$@"
