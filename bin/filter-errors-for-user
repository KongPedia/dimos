#!/usr/bin/env python3

# Used when running `./bin/mypy-strict --for-me`

import re
import subprocess
import sys

_blame = {}


def _is_for_user(file, line_no, user_email):
    if file not in _blame:
        _blame[file] = _get_git_blame_for_file(file)
    return _blame[file][line_no] == user_email


def _get_git_blame_for_file(file_name):
    try:
        result = subprocess.run(
            ["git", "blame", "--show-email", "-e", file_name],
            capture_output=True,
            text=True,
            check=True,
        )

        blame_map = {}
        # Each line looks like: ^abc123 (<email@example.com> 2024-01-01 12:00:00 +0000 1) code
        blame_pattern = re.compile(r"^[^\(]+\(<([^>]+)>")

        for i, line in enumerate(result.stdout.split("\n")):
            if not line:
                continue
            match = blame_pattern.match(line)
            if match:
                email = match.group(1)
                blame_map[str(i + 1)] = email

        return blame_map
    except subprocess.CalledProcessError:
        return {}


def main():
    if len(sys.argv) != 2:
        print("Usage: filter-errors-for-user <git-email>", file=sys.stderr)
        sys.exit(1)

    user_email = sys.argv[1]

    for line in sys.stdin.readlines():
        split = re.findall(r"^([^:]+):(\d+):(.*)", line)
        if not split or len(split[0]) != 3:
            continue
        file, line_no = split[0][:2]
        if not file.startswith("dimos/"):
            continue
        if _is_for_user(file, line_no, user_email):
            print(":".join(split[0]))


if __name__ == "__main__":
    main()
