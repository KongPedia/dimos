#!/usr/bin/env python3

# Used to filter errors to only show lines committed on or after a specific date
# Can be chained with filter-errors-for-user

from datetime import datetime
import re
import subprocess
import sys

_blame = {}


def _is_after_date(file, line_no, cutoff_date):
    if file not in _blame:
        _blame[file] = _get_git_blame_dates_for_file(file)
    line_date = _blame[file].get(line_no)
    if not line_date:
        return False
    return line_date >= cutoff_date


def _get_git_blame_dates_for_file(file_name):
    try:
        result = subprocess.run(
            ["git", "blame", "--date=short", file_name],
            capture_output=True,
            text=True,
            check=True,
        )

        blame_map = {}
        # Each line looks like: ^abc123 (Author Name 2024-01-01 1) code
        blame_pattern = re.compile(r"^[^\(]+\([^\)]+(\d{4}-\d{2}-\d{2})")

        for i, line in enumerate(result.stdout.split("\n")):
            if not line:
                continue
            match = blame_pattern.match(line)
            if match:
                date_str = match.group(1)
                blame_map[str(i + 1)] = date_str

        return blame_map
    except subprocess.CalledProcessError:
        return {}


def main():
    if len(sys.argv) != 2:
        print("Usage: filter-errors-after-date <date>", file=sys.stderr)
        print("  Example: filter-errors-after-date 2025-10-04", file=sys.stderr)
        sys.exit(1)

    cutoff_date = sys.argv[1]

    try:
        datetime.strptime(cutoff_date, "%Y-%m-%d")
    except ValueError:
        print(f"Error: Invalid date format '{cutoff_date}'. Use YYYY-MM-DD", file=sys.stderr)
        sys.exit(1)

    for line in sys.stdin.readlines():
        split = re.findall(r"^([^:]+):(\d+):(.*)", line)
        if not split or len(split[0]) != 3:
            continue

        file, line_no = split[0][:2]
        if not file.startswith("dimos/"):
            continue

        if _is_after_date(file, line_no, cutoff_date):
            print(":".join(split[0]))


if __name__ == "__main__":
    main()
